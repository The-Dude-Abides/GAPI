<!--python -m SimpleHTTPServer 8000-->

<!DOCTYPE html>
<html lang="en">
<!-- Seems to be broken checking for errors -->

<head>
    <meta charset="utf-8">
    <title>Agent ScoreCard v1.3 (DEV)</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <script type="text/javascript" src="credentials.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Josefin+Sans:100,400,600,700">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
    <link href="scorecard-style.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script type="text/javascript" src="../tableexport/js/tableexport.min.js"></script>


</head>

<style></style>

<body>
    <div class="navbar">
        <button id="signin-button" onclick="handleSignInClick()">Sign In</button>
        <button id="mtdagentSC-button" class="whichReport-button">MtD Agent ScoreCard</button>
        <button id="wtdagentSC-button" class="whichReport-button">WtD Agent ScoreCard</button>
        <button id="eodagentSC-button" class="whichReport-button">EoD Agent ScoreCard</button>
        <button id="mtdsupSC-button" class="whichReport-button">MtD Supervisor ScoreCard</button>
        <button id="legend-button" class="whichReport-button">Legend</button>
        <button id="export-button" class="excel export">Export to Excel</button>
    </div>
    
    <!-- WARNING: these may not be versatile. Please confirm that these are versatile during testing phases -->
    
    <!-- EXPLORE THIS OPTION ... DO WE WANNA USE EXPORT PACKAGE? -->
    <!-- https://www.jqueryscript.net/table/Exporting-Html-Tables-To-CSV-XLS-XLSX-Text-TableExport.html -->

    <input type="text" id="tableInputLocation" class="search-key" onkeyup="searchAll()" placeholder="Search by Location">
    <input type="text" id="tableInputPosition" class="search-key" onkeyup="searchAll()" placeholder="Search by Position">
    <input type="text" id="tableInputManager" class="search-key" onkeyup="searchAll()" placeholder="Search by Manager">
    <input type="text" id="tableInputSupervisor" class="search-key" onkeyup="searchAll()" placeholder="Search by Sup">
    <input type="text" id="tableInputAgent" class="search-key" onkeyup="searchAll()" placeholder="Search by Agent">
    <div id="filter-break"></div>
    <input type="text" id="tableInputFCR" class="search-key" onkeyup="searchAll()" placeholder="filter fcr">
    <input type="text" id="tableInputAE" class="search-key" onkeyup="searchAll()" placeholder="filter agent ease">
    <input type="text" id="tableInputAHT" class="search-key" onkeyup="searchAll()" placeholder="filter aht">
    <input type="text" id="tableInputAUX" class="search-key" onkeyup="searchAll()" placeholder="filter aux">
    <input type="text" id="tableInputINBOUND" class="search-key" onkeyup="searchAll()" placeholder="filter inbound calls">
    <input type="text" id="tableInputPLC" class="search-key" onkeyup="searchAll()" placeholder="filter plc">
    <input type="text" id="tableInputRESOLVED" class="search-key" onkeyup="searchAll()" placeholder="filter tickets resolved">
    <input type="text" id="tableInputCALLS" class="search-key" onkeyup="searchAll()" placeholder="filter call count">
    <input type="text" id="tableInputCHATS" class="search-key" onkeyup="searchAll()" placeholder="filter chat count">
    <input type="text" id="tableInputDcast" class="search-key" onkeyup="searchAll()" placeholder="filter dcast %">


    <div class="table-responsive-lg">
        <h2>Agent Scorecard</h2>
        <table class="table" id="theTable">
            <!--BOOTSTRAP CLASS-->
            <thead id="tableHead">
                <tr id="headerRow" class="header"></tr>
            </thead>
            <tbody id=tableBody>
            </tbody>
        </table>
    </div>


</body>

<script type="text/javascript">

    let results;
    let values;

    let sheet_ID;
    let sheet_range;

    const tableToExcel = '';

    $(document).ready(function () {
        

        $('#mtdagentSC-button').on('click', function () {
            event.preventDefault();
            sheet_ID = mtd_autofill.sheet_ID;
            sheet_range = mtd_autofill.sheet_range;
            selectedTable();
        });
        $('#wtdagentSC-button').on('click', function () {
            event.preventDefault();
            sheet_ID = wtd_autofill.sheet_ID;
            sheet_range = wtd_autofill.sheet_range;
            selectedTable();
        });
        $('#eodagentSC-button').on('click', function () {
            event.preventDefault();
            sheet_ID = eod_autofill.sheet_ID;
            sheet_range = eod_autofill.sheet_range;
            selectedTable();
        });
        $('#mtdsupSC-button').on('click', function () {
            event.preventDefault();
            sheet_ID = mtd_supimp.sheet_ID;
            sheet_range = mtd_supimp.sheet_range;
            selectedTable();
        });
        $('#legend-button').on('click', function () {
            event.preventDefault();
            sheet_ID = legend.sheet_ID;
            sheet_range = legend.sheet_range;
            selectedTable();
        });
        
        $('#export-button').on('click', function () {
        event.preventDefault();
        $('#theTable').tableExport();
        });

        function selectedTable() {
            $('#headerRow').empty();
            $('#tableBody').empty();
            makeApiCall();
        }

        // CALL GSHEETS
        function makeApiCall() {
            const params = {
                spreadsheetId: sheet_ID, // make a constiable, switchable by button
                range: sheet_range, // make a constiable, switchable by button
                valueRenderOption: 'FORMATTED_VALUE',
                dateTimeRenderOption: 'SERIAL_NUMBER'
            };

            const request = gapi.client.sheets.spreadsheets.values.get(params);
            request.then(function (response) {
                renderTable(response.result.values);
            });
        }

// $('#export-button').on('click', function tableToExcel() {
    // var tableToExcel = (function() {
    //     var uri = 'data:application/vnd.ms-excel;base64,'
    //     , template = 
    //     '{table}'
    //     , base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
    //     , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
    //     return function(table, name) {
    //     if (!table.nodeType) table = document.getElementById(table)
    //     var ctx = {worksheet: name || 'Worksheet', table: table.innerHTML}
    //     window.location.href = uri + base64(format(template, ctx))
    //     }
    // })()
    // tableToExcel();


    }); // END DOCUMENT READY

    function renderTable(tableData) {

        const table = document.getElementById("tableBody");
        const tableHead = document.getElementById("headerRow");

        tableData.forEach((data, i) => {
            if (i === 0) {
                for (const titleItem of data) {
                    tableHead.insertCell().append(titleItem);
                }
                
            } else {
                const row = table.insertRow();
                for (const dataItem of data) {
                    row.insertCell().append(dataItem);
                }
            }

        });

        // const colNum = $(this).cellIndex

        const dimension = ['date range', 'date interval', 'location: most recent', 'manager: most recent', 'position: most recent', 'supervisor: most recent', 'agent name', 'agent email'];
        const formatted = ['7 day call fcr', 'agent ease', 'replacement rate', 'aux', 'aht', 'deltacast'];

        // const length = $('thead td').length;
        $('thead td').each(function(i) {
            const label = this.innerHTML;
            let fieldType = '';
            
            if (dimension.includes(label)) {
                fieldType = 'dimension';
            }
            if (formatted.includes(label)) {
                fieldType = 'formatted-metric';
            } else {
                fieldType = 'metric';
            }
            const hyph = label.replace(/[%:]/g, '')
                                     .trim()
                                     .replace(/ /g, '-');

            let startCol = i + 1;
            $('tbody td:nth-child(' + startCol + ')').addClass(hyph + ' ' + fieldType + ' ' + i);
        });

        let status;
        $('.aht').each(function () {
            const exceptional = 600;
            const effective = 720;
            const achieves = 840;
            const NI = 1050;
            const cellText = $(this).text();
            const noComma = cellText.replace(/\,/g, '');
            const cellNum = parseFloat(noComma);
            // NEED TO PUSH VALUE WHERE AHT/60 TO CHANGE TO MINUTES

            if (cellNum <= exceptional) {
                status = 'exceptional';
            }
            if (cellNum > exceptional && cellNum <= effective) {
                status = 'effective';
            }
            if (cellNum > effective && cellNum <= achieves) {
                status = 'achieves';
            }
            if (cellNum > achieves && cellNum <= NI) {
                status = 'NI';
            }
            if (cellNum > NI) {
                status = 'unacceptable';
            }

            $(this).addClass(status);
        });

        $('.7-day-call-fcr').each(function () {
            const exceptional = 82.00;
            const effective = 80.00;
            const achieves = 78.00;
            const NI = 76.00;
            const cellText = $(this).text();
            const noComma = cellText.replace(/\,/g, '');
            const cellNum = parseFloat(noComma);

            if (cellNum <= exceptional) {
                status = 'exceptional';
            }
            if (cellNum > exceptional && cellNum <= effective) {
                status = 'effective';
            }
            if (cellNum > effective && cellNum <= achieves) {
                status = 'achieves';
            }
            if (cellNum > achieves && cellNum <= NI) {
                status = 'NI';
            }
            if (cellNum > NI) {
                status = 'unacceptable';
            }

            $(this).addClass(status);
        });

        $('.agent-ease').each(function () {
            const exceptional = 9.9;
            const effective = 9.7;
            const achieves = 9.5;
            const NI = 9.2;
            const cellText = $(this).text();
            const cellNum = parseFloat(cellText);

            if (cellNum >= exceptional) {
                status = 'exceptional';
            }
            if (cellNum < exceptional && cellNum >= effective) {
                status = 'effective';
            }
            if (cellNum < effective && cellNum >= achieves) {
                status = 'achieves';
            }
            if (cellNum < achieves && cellNum >= NI) {
                status = 'NI';
            }
            if (cellNum < NI) {
                status = 'unacceptable';
            }

            $(this).addClass(status);
        });

        $('.replacement-rate').each(function () {
            const exceptional = .06;
            const effective = .07;
            const achieves = .08;
            const NI = .09;
            const cellText = $(this).text();
            const cellNum = parseFloat(cellText);

            if (cellNum >= exceptional) {
                status = 'exceptional';
            }
            if (cellNum < exceptional && cellNum >= effective) {
                status = 'effective';
            }
            if (cellNum < effective && cellNum >= achieves) {
                status = 'achieves';
            }
            if (cellNum < achieves && cellNum >= NI) {
                status = 'NI';
            }
            if (cellNum < NI) {
                status = 'unacceptable';
            }

            $(this).addClass(status);
        });

        $('.aux').each(function () {
            const exceptional = 82.0;
            const effective = 80.0;
            const achieves = 78.0;
            const NI = 50.0;
            const cellText = $(this).text();
            const cellNum = cellText.replace(/\D/g, '');

            if (cellNum <= exceptional) {
                status = 'exceptional';
            }
            if (cellNum > exceptional && cellNum <= effective) {
                status = 'effective';
            }
            if (cellNum > effective && cellNum <= achieves) {
                status = 'achieves';
            }
            if (cellNum > achieves && cellNum <= NI) {
                status = 'NI';
            }
            if (cellNum > NI) {
                status = 'unacceptable';
            }

            $(this).addClass(status);
        });

        const cells = $(tableHead).find('td');
        cells.each(function (i) {
            cells[i].onclick = (function (n) {
                return function () {
                    sortTable(n);
                };
            })(i);
        });
    }

    function initClient() {
        const API_KEY = credentials.gapi_Key;
        const CLIENT_ID = credentials.gapi_Client;
        const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';
        gapi.client.init({
            'apiKey': API_KEY,
            'clientId': CLIENT_ID,
            'scope': SCOPE,
            'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4']
        }).then(function () {
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
            updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        });
    }

    function handleClientLoad() {
        gapi.load('client:auth2', initClient);
    }

    function updateSignInStatus(isSignedIn) {
        $('#tableBody').prepend('Please select a report from the nav bar');
    }

    function handleSignInClick(event) {
        gapi.auth2.getAuthInstance().signIn();
    }

    function searchAll() {
        let table, trs, tds;
        table = document.getElementById('tableBody');
        trs = Array.from(table.getElementsByTagName('tr'));

        const vlu = [];

        vlu.push(document.getElementById('tableInputLocation').value);
        vlu.push(document.getElementById('tableInputPosition').value);
        vlu.push(document.getElementById('tableInputManager').value);
        vlu.push(document.getElementById('tableInputSupervisor').value);
        vlu.push(document.getElementById('tableInputAgent').value);
        vlu.push(document.getElementById('tableInputFCR').value);
        vlu.push(document.getElementById('tableInputAE').value);
        vlu.push(document.getElementById('tableInputAHT').value);
        vlu.push(document.getElementById('tableInputAUX').value);
        vlu.push(document.getElementById('tableInputINBOUND').value);
        vlu.push(document.getElementById('tableInputPLC').value);
        vlu.push(document.getElementById('tableInputRESOLVED').value);
        vlu.push(document.getElementById('tableInputCALLS').value);
        vlu.push(document.getElementById('tableInputCHATS').value);
        vlu.push(document.getElementById('tableInputDcast').value);

        trs.forEach(function(tr, i) {
            const filter1 = vlu[0].toUpperCase();
            const filter2 = vlu[1].toUpperCase();
            const filter3 = vlu[2].toUpperCase();
            const filter4 = vlu[3].toUpperCase();
            const filter5 = vlu[4].toUpperCase();
            const filter6 = vlu[5].toUpperCase();
            const filter7 = vlu[6].toUpperCase();
            const filter8 = vlu[7].toUpperCase();
            const filter9 = vlu[8].toUpperCase();
            const filter10 = vlu[9].toUpperCase();
            const filter11 = vlu[10].toUpperCase();
            const filter12 = vlu[11].toUpperCase();
            const filter13 = vlu[12].toUpperCase();
            const filter14 = vlu[13].toUpperCase();
            const filter15 = vlu[14].toUpperCase();

            const td = tr.getElementsByTagName("td")[2];
            const tv = tr.getElementsByTagName("td")[3];
            const tz = tr.getElementsByTagName("td")[4];
            const tq = tr.getElementsByTagName("td")[5];
            const tc = tr.getElementsByTagName("td")[6];
            const ta = tr.getElementsByTagName("td")[7];
            const tb = tr.getElementsByTagName("td")[8];
            const te = tr.getElementsByTagName("td")[9];
            const tf = tr.getElementsByTagName("td")[10];
            const tg = tr.getElementsByTagName("td")[11];
            const th = tr.getElementsByTagName("td")[12];
            const ti = tr.getElementsByTagName("td")[13];
            const tj = tr.getElementsByTagName("td")[14];
            const tk = tr.getElementsByTagName("td")[15];
            const tn = tr.getElementsByTagName("td")[16];

            if (td && tz && tv && tq && tc && ta && tb && te && tf && tg && th && ti && tj && tk && tn) {
                if (td.innerHTML.toUpperCase().indexOf(filter1) > -1 &&
                    tz.innerHTML.toUpperCase().indexOf(filter2) > -1 &&
                    tv.innerHTML.toUpperCase().indexOf(filter3) > -1 &&
                    tq.innerHTML.toUpperCase().indexOf(filter4) > -1 &&
                    tc.innerHTML.toUpperCase().indexOf(filter5) > -1 &&

                    ta.innerHTML.toUpperCase().indexOf(filter6) > -1 &&
                    tb.innerHTML.toUpperCase().indexOf(filter7) > -1 &&
                    te.innerHTML.toUpperCase().indexOf(filter8) > -1 &&
                    tf.innerHTML.toUpperCase().indexOf(filter9) > -1 &&
                    tg.innerHTML.toUpperCase().indexOf(filter10) > -1 &&
                    th.innerHTML.toUpperCase().indexOf(filter11) > -1 &&
                    ti.innerHTML.toUpperCase().indexOf(filter12) > -1 &&
                    tj.innerHTML.toUpperCase().indexOf(filter13) > -1 &&
                    tk.innerHTML.toUpperCase().indexOf(filter14) > -1 &&
                    tn.innerHTML.toUpperCase().indexOf(filter15) > -1) {
                    tr.style.display = "";
                } else {
                    tr.style.display = "none"
                }
            }
        });
    }


    function sortTable(n) {
        let table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById('tableBody');
        const head = document.getElementById('tableHead').getElementsByTagName('td')[n];
        const head$ = $(head);

        switching = true;
        dir = 'asc';

        if (head$.hasClass('asc')) {
            dir = 'desc';
            head$.removeClass('asc');
            head$.addClass('desc');
        } else {
            head$.removeClass('desc');
            head$.addClass('asc')
        }

        rows = Array.from(table.getElementsByTagName('tr'));

        rows.sort((a, b) => {
            const x = a.getElementsByTagName('td')[n].innerHTML.toLowerCase();
            const y = b.getElementsByTagName('td')[n].innerHTML.toLowerCase();

            if (x === '' && y === '') {
                const agentX = $(a).find('.agent-name').text().toLowerCase();
                const agentY = $(b).find('.agent-name').text().toLowerCase()
                

                if ( dir === 'asc') {
                    return agentX.localeCompare(agentY);
                }
                return agentY.localeCompare(agentX);
            }


            if (!(Number.isNaN(parseFloat(x)) || Number.isNaN(parseFloat(y)))) {
                if (dir === 'asc') {
                    return parseFloat(x) - parseFloat(y);
                }

                return parseFloat(y) - parseFloat(x);
            }

            if ( dir === 'asc') {
                return x.localeCompare(y);
            }
            return y.localeCompare(x);
        });

        const table$ = $(table);
        table$.empty();
        rows.forEach(row => table$.append(row));

    }
</script>
<script>
    handleClientLoad();
</script>
</body>

</html>